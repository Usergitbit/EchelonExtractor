(()=>{"use strict";var e=(()=>(function(e){e[e.Load=0]="Load",e[e.ExtractEchelons=1]="ExtractEchelons",e[e.CombineEchelons=2]="CombineEchelons"}(e||(e={})),e))(),n=(()=>(function(e){e[e.LoadCompleted=0]="LoadCompleted",e[e.EchelonExtracted=1]="EchelonExtracted",e[e.EchelonsCombined=2]="EchelonsCombined",e[e.Error=3]="Error"}(n||(n={})),n))();function t(e,t){s({information:a(n.Error,t.information.requestId,t.information.processingUnitId,`There was an error processing the request. Message:${e.message}. Line number ${e.lineno} Column number: ${e.colno}`)})}function o(e){const n=new ImageData(new Uint8ClampedArray(e.imageArrayBuffer),e.width,e.height),t=cv.matFromImageData(n),o=cv.matFromImageData(n);cv.cvtColor(o,o,cv.COLOR_RGBA2GRAY,0),cv.threshold(o,o,50,250,cv.THRESH_BINARY);const a=new cv.MatVector,i=new cv.Mat;cv.findContours(o,a,i,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE);const s=new Array;for(let d=0;d<a.size();d++){const e=a.get(d),n=cv.boundingRect(e),o=n.width/n.height;if(r(o,n.width)||c(o,n.width)){const e=t.roi(n),o=m(e);s.push(o),e.delete()}e.delete()}return i.delete(),a.delete(),o.delete(),t.delete(),s.reverse()}function r(e,n){return e>=6.1&&e<=6.5&&n>200}function c(e,n){return e>=4.7&&e<=5&&n>200}function a(e,n,t,o){return{requestId:n,responseType:e,message:o,processingUnitId:t}}function i(e){const n=new Array;return e.forEach(e=>{n.push({imageArrayBuffer:e.data.buffer,height:e.height,width:e.width})}),{images:n}}function s(e){if(e.content){const n=e.content.images.map(e=>e.imageArrayBuffer);postMessage(e,n)}else postMessage(e)}function d(e,n){return"opencv_js.wasm"===e?n+"assets/opencv/wasm/4.4/"+e:n+e}function m(e){const n=new cv.Mat,t=e.type()%8,o=t<=cv.CV_8S?1:t<=cv.CV_32S?1/256:255,r=t===cv.CV_8S||t===cv.CV_16S?128:0;switch(e.convertTo(n,cv.CV_8U,o,r),n.type()){case cv.CV_8UC1:cv.cvtColor(n,n,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(n,n,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const c=new ImageData(new Uint8ClampedArray(n.data),n.cols,n.rows);return n.delete(),c}addEventListener("message",r=>{const c=r.data;switch(c.information.requestType){case e.Load:try{!function(e){var t,o,r;t=this,r=function*(){console.log("Recieved load request"),self.Module={wasmBinaryFile:"assets/opencv/wasm/4.4/opencv_js.wasm",usingWasm:!0,locateFile:d,onRuntimeInitialized:()=>{s({information:{responseType:n.LoadCompleted,requestId:e.information.requestId,processingUnitId:e.information.processingUnitId}})}},self.importScripts("./assets/opencv/wasm/4.4/opencv.js"),cv=yield cv()},new((o=void 0)||(o=Promise))(function(e,n){function c(e){try{i(r.next(e))}catch(t){n(t)}}function a(e){try{i(r.throw(e))}catch(t){n(t)}}function i(n){var t;n.done?e(n.value):(t=n.value,t instanceof o?t:new o(function(e){e(t)})).then(c,a)}i((r=r.apply(t,[])).next())})}(c)}catch(u){t(u,c)}break;case e.ExtractEchelons:try{!function(e){if(!e.content)throw new Error("Image content must not be null or undefined");const t=e.content.images,r=new Array;for(const n of t)o(n).forEach(e=>{r.push(e)});s({information:a(n.EchelonExtracted,e.information.requestId,e.information.processingUnitId),content:i(r)})}(c)}catch(u){t(u,c)}break;case e.CombineEchelons:try{!function(e){if(!e.content)throw new Error("Image content must not be null or undefined");const t=function(e){let n=e.reduce((e,n)=>e+n.height,0);const t=e.reduce((e,n)=>e>n.width?e:n.width,0);let o=cv.CV_8UC4;const r=cv.Mat.ones(n,t,o);let c=0,a=e[0].height;for(let s=0;s<e.length;s++){const t=e[s],i=new ImageData(new Uint8ClampedArray(t.imageArrayBuffer),t.width,t.height),d=cv.matFromImageData(i);n+=d.rows,o=d.type(),d.copyTo(r.rowRange(c,a).colRange(0,d.cols)),s!==e.length-1&&(c=a,a+=e[s+1].height),d.delete()}const i=m(r);return r.delete(),i}(e.content.images);s({information:a(n.EchelonsCombined,e.information.requestId,e.information.processingUnitId),content:i(new Array(t))})}(c)}catch(u){t(u,c)}break;default:throw new Error(`Request type ${c.information.requestType} not implemented.`)}})})();